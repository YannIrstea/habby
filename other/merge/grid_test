import Merge
import time
import numpy as np
from plot_merge_check import plot_to_check_mesh_merging


def run_test(nbpointhyd, nbpointsub, seedhyd, seedsub, coeffgrid):
    defautsub = np.array([1, 1])
    xyhyd, iklehyd, xysub, iklesub, datasub = Merge.build_hyd_sub_mesh(False, nbpointhyd, nbpointsub, seedhyd, seedsub)
    t0 = time.time()
    nxymerge1, niklemerge1, datasubmerge = Merge.merge(xyhyd, iklehyd, xysub, iklesub, datasub, defautsub, coeffgrid)
    t1 = time.time()
    dt = t1 - t0
    print(dt)
    pass  # TODO finish this


# run_test(5000, 7000, 9, 32, 0.5)


def create_mesh_in_shape(rectangles,seedhyd=None,seedsub=None):
    """
    :param rectangles: numpy array with 6 columns where each line contains (x0, y0, width, height, npointhyd, npointsub) for a rectangle
    :return: xyhyd,iklehyd,xysub,iklesub,datasub
    """
    xyhyd, iklehyd, xysub, iklesub, datasub = Merge.build_hyd_sub_mesh(False,rectangles[0][4],rectangles[0][5],seedhyd,seedsub,rectangles[0][:2],rectangles[0][2:4])
    # xyhyd=np.array(xyhyd)
    for line in rectangles[1:]:
        xyhydi, iklehydi, xysubi, iklesubi, datasubi =Merge.build_hyd_sub_mesh(False,line[4],line[5],seedhyd,seedsub,line[:2],line[2:4])
        iklehyd=np.concatenate((iklehyd,iklehydi+len(xyhyd))) #must correct the index values for the triangle vertices by len(xyhyd)
        iklesub = np.concatenate((iklesub, iklesubi + len(xysub)))
        xyhyd=np.concatenate((xyhyd,xyhydi))
        # iklehyd = np.concatenate((iklehyd, iklehydi))
        xysub=np.concatenate((xysub,xysubi))

        # iklesub = np.concatenate((iklesub, iklesubi))
        datasub=np.concatenate((datasub,datasubi))
    print(iklehyd)

    return xyhyd,iklehyd,xysub,iklesub,datasub

defautsub=np.array([1,1])
coeffgrid=0.5
xyhyd,iklehyd,xysub,iklesub,datasub=create_mesh_in_shape(np.array(((0,0,70,20,100,100),(50,20,20,40,100,100))),seedhyd=7,seedsub=15)
print(xyhyd,iklehyd,xysub,iklesub,datasub)


nxymerge1, niklemerge1, datasubmerge = Merge.merge(xyhyd, iklehyd, xysub, iklesub, datasub, defautsub, coeffgrid)

plot_to_check_mesh_merging(xyhyd,iklehyd,xysub,iklesub,datasub[:,0], nxymerge1,niklemerge1,np.array(datasubmerge)[:,0])



